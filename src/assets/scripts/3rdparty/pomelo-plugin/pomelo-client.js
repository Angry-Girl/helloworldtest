(function(){function e(e){if(e)return n(e)}function n(n){for(var t in e.prototype)n[t]=e.prototype[t];return n}e.prototype.on=e.prototype.addEventListener=function(e,n,t=null){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push({fn:n,target:t}),this},e.prototype.once=function(e,n){var t=this;function o(){t.off(e,o),n.apply(this,arguments)}return this._callbacks=this._callbacks||{},o.fn=n,this.on(e,o),this},e.prototype.off=e.prototype.removeListener=e.prototype.removeAllListeners=e.prototype.removeEventListener=function(e,n,t=null){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var o,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var i=0;i<r.length;i++)if((o=r[i]).fn===n&&o.target===t){r.splice(i,1);break}return this},e.prototype.emit=function(e){this._callbacks=this._callbacks||{};var n=[].slice.call(arguments,1),t=this._callbacks[e];if(t)for(var o=0,r=(t=t.slice(0)).length;o<r;++o){var i=t[o],c=i.fn,a=i.target;c.apply(a,n)}return this},e.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},e.prototype.hasListeners=function(e){return!!this.listeners(e).length},"undefined"!=typeof window&&(window.EventEmitter=e)})(),function(e,n,t){var o=e,r=o.Package={},i=o.Message={};r.TYPE_HANDSHAKE=1,r.TYPE_HANDSHAKE_ACK=2,r.TYPE_HEARTBEAT=3,r.TYPE_DATA=4,r.TYPE_KICK=5,i.TYPE_REQUEST=0,i.TYPE_NOTIFY=1,i.TYPE_RESPONSE=2,i.TYPE_PUSH=3,o.strencode=function(e){for(var t=new n(3*e.length),o=0,r=0;r<e.length;r++){var i=e.charCodeAt(r),a=null;a=i<=127?[i]:i<=2047?[192|i>>6,128|63&i]:[224|i>>12,128|(4032&i)>>6,128|63&i];for(var s=0;s<a.length;s++)t[o]=a[s],++o}var u=new n(o);return c(u,0,t,0,o),u},o.strdecode=function(e){for(var t=new n(e),o=[],r=0,i=0,c=t.length;r<c;)t[r]<128?(i=t[r],r+=1):t[r]<224?(i=((63&t[r])<<6)+(63&t[r+1]),r+=2):224==(240&t[r])?(i=((15&t[r])<<12)+((63&t[r+1])<<6)+(63&t[r+2]),r+=3):240==(248&t[r])?(i=63,r+=4):(i=63,r+=1),o.push(i);return String.fromCharCode.apply(null,o)},r.encode=function(e,t){var o=t?t.length:0,r=new n(4+o),i=0;return r[i++]=255&e,r[i++]=o>>16&255,r[i++]=o>>8&255,r[i++]=255&o,t&&c(r,i,t,0,o),r},r.decode=function(e){for(var t=0,o=new n(e),r=0,i=[];t<o.length;){var a=o[t++],s=(r=(o[t++]<<16|o[t++]<<8|o[t++])>>>0)?new n(r):null;c(s,0,o,t,r),t+=r,i.push({type:a,body:s})}return 1===i.length?i[0]:i},i.encode=function(e,t,r,i,c){var h=1+(a(t)?u(e):0);if(s(t))if(r){if("number"!=typeof i)throw new Error("error flag for number route!");h+=2}else if(h+=1,i){if((i=o.strencode(i)).length>255)throw new Error("route maxlength is overflow");h+=i.length}c&&(h+=c.length);var y=new n(h),v=0;return v=l(t,r,y,v),a(t)&&(v=f(e,y,v)),s(t)&&(v=d(r,i,y,v)),c&&(v=p(c,y,v)),y},i.decode=function(e){var t=new n(e),r=t.length||t.byteLength,i=0,u=0,l=null,f=t[i++],d=1&f,p=f>>1&7;if(a(p)){var h=parseInt(t[i]),y=0;do{u+=(127&(h=parseInt(t[i])))*Math.pow(2,7*y),i++,y++}while(h>=128)}if(s(p))if(d)l=t[i++]<<8|t[i++];else{var v=t[i++];v?(l=new n(v),c(l,0,t,i,v),l=o.strdecode(l)):l="",i+=v}var g=r-i,w=new n(g);return c(w,0,t,i,g),{id:u,type:p,compressRoute:d,route:l,body:w}};var c=function(e,n,t,o,r){if("function"==typeof t.copy)t.copy(e,n,o,o+r);else for(var i=0;i<r;i++)e[n++]=t[o++]},a=function(e){return e===i.TYPE_REQUEST||e===i.TYPE_RESPONSE},s=function(e){return e===i.TYPE_REQUEST||e===i.TYPE_NOTIFY||e===i.TYPE_PUSH},u=function(e){var n=0;do{n+=1,e>>=7}while(e>0);return n},l=function(e,n,t,o){if(e!==i.TYPE_REQUEST&&e!==i.TYPE_NOTIFY&&e!==i.TYPE_RESPONSE&&e!==i.TYPE_PUSH)throw new Error("unkonw message type: "+e);return t[o]=e<<1|(n?1:0),o+1},f=function(e,n,t){do{var o=e%128,r=Math.floor(e/128);0!==r&&(o+=128),n[t++]=o,e=r}while(0!==e);return t},d=function(e,n,t,o){if(e){if(n>65535)throw new Error("route number is overflow");t[o++]=n>>8&255,t[o++]=255&n}else n?(t[o++]=255&n.length,c(t,o,n,0,n.length),o+=n.length):t[o++]=0;return o},p=function(e,n,t){return c(n,t,e,0,e.length),t+e.length};"undefined"!=typeof window&&(window.Protocol=o)}("undefined"==typeof window?module.exports:{},"undefined"==typeof window?Buffer:Uint8Array),function(e,n){var t=typeof window=="undefined"?module.exports:{};t.init=function(e){t.encoder.init(e.encoderProtos),t.decoder.init(e.decoderProtos)},t.encode=function(e,n){return t.encoder.encode(e,n)},t.decode=function(e,n){return t.decoder.decode(e,n)},"undefined"!=typeof window&&(window.protobuf=t)}(),(("undefined"!=typeof protobuf?protobuf:module.exports).constants={}).TYPES={uInt32:0,sInt32:0,int32:0,double:1,string:2,message:2,float:5},(("undefined"!=typeof protobuf?protobuf:module.exports).util={}).isSimpleType=function(e){return"uInt32"===e||"sInt32"===e||"int32"===e||"uInt64"===e||"sInt64"===e||"float"===e||"double"===e},function(e,n){var t=("undefined"!==typeof protobuf?protobuf:module.exports).codec={},o=new ArrayBuffer(8),r=new Float32Array(o),i=new Float64Array(o),c=new Uint8Array(o);function a(e){return e<=127?[e]:e<=2047?[192|e>>6,128|63&e]:[224|e>>12,128|(4032&e)>>6,128|63&e]}function s(e){return e<=127?1:e<=2047?2:3}t.encodeUInt32=function(e){e=parseInt(e);if(isNaN(e)||e<0)return null;var n=[];do{var t=e%128,o=Math.floor(e/128);0!==o&&(t+=128),n.push(t),e=o}while(0!==e);return n},t.encodeSInt32=function(e){e=parseInt(e);return isNaN(e)?null:(e=e<0?2*Math.abs(e)-1:2*e,t.encodeUInt32(e))},t.decodeUInt32=function(e){for(var n=0,t=0;t<e.length;t++){var o=parseInt(e[t]);if(n+=(127&o)*Math.pow(2,7*t),o<128)return n}return n},t.decodeSInt32=function(e){var n=this.decodeUInt32(e);return n=(n%2+n)/2*(n%2==1?-1:1)},t.encodeFloat=function(e){return r[0]=e,c},t.decodeFloat=function(e,n){if(!e||e.length<n+4)return null;for(var t=0;t<4;t++)c[t]=e[n+t];return r[0]},t.encodeDouble=function(e){return i[0]=e,c.subarray(0,8)},t.decodeDouble=function(e,n){if(!e||e.length<n+8)return null;for(var t=0;t<8;t++)c[t]=e[n+t];return i[0]},t.encodeStr=function(e,n,t){for(var o=0;o<t.length;o++)for(var r=a(t.charCodeAt(o)),i=0;i<r.length;i++)e[n]=r[i],n++;return n},t.decodeStr=function(e,n,t){for(var o=[],r=n+t;n<r;){var i=0;e[n]<128?(i=e[n],n+=1):e[n]<224?(i=((63&e[n])<<6)+(63&e[n+1]),n+=2):(i=((15&e[n])<<12)+((63&e[n+1])<<6)+(63&e[n+2]),n+=3),o.push(i)}for(var c="",a=0;a<o.length;)c+=String.fromCharCode.apply(null,o.slice(a,a+1e4)),a+=1e4;return c},t.byteLength=function(e){if("string"!=typeof e)return-1;for(var n=0,t=0;t<e.length;t++){n+=s(e.charCodeAt(t))}return n}}(),function(e,n){var t=e,o=e.encoder={},r=t.codec,i=t.constants,c=t.util;function a(e,n){if(!n)return!1;for(var t in n){var r=n[t];switch(r.option){case"required":if(void 0===e[t])return console.warn("no property exist for required! name: %j, proto: %j, msg: %j",t,r,e),!1;case"optional":if(void 0!==e[t])if((i=n.__messages[r.type]||o.protos["message "+r.type])&&!a(e[t],i))return console.warn("inner proto error! name: %j, proto: %j, msg: %j",t,r,e),!1;break;case"repeated":var i=n.__messages[r.type]||o.protos["message "+r.type];if(e[t]&&i)for(var c=0;c<e[t].length;c++)if(!a(e[t][c],i))return!1}}return!0}function s(e,n,t,o){for(var r in o)if(t[r]){var i=t[r];switch(i.option){case"required":case"optional":n=f(e,n,d(i.type,i.tag)),n=u(o[r],i.type,n,e,t);break;case"repeated":o[r].length>0&&(n=l(o[r],i,n,e,t))}}return n}function u(e,n,t,i,c){switch(n){case"uInt32":t=f(i,t,r.encodeUInt32(e));break;case"int32":case"sInt32":t=f(i,t,r.encodeSInt32(e));break;case"float":f(i,t,r.encodeFloat(e)),t+=4;break;case"double":f(i,t,r.encodeDouble(e)),t+=8;break;case"string":var a=r.byteLength(e);t=f(i,t,r.encodeUInt32(a)),r.encodeStr(i,t,e),t+=a;break;default:var u=c.__messages[n]||o.protos["message "+n];if(u){var l=new ArrayBuffer(2*r.byteLength(JSON.stringify(e)));a=s(l,a=0,u,e),t=f(i,t,r.encodeUInt32(a));for(var d=0;d<a;d++)i[t]=l[d],t++}}return t}function l(e,n,t,o,i){var a=0;if(c.isSimpleType(n.type))for(t=f(o,t=f(o,t,d(n.type,n.tag)),r.encodeUInt32(e.length)),a=0;a<e.length;a++)t=u(e[a],n.type,t,o);else for(a=0;a<e.length;a++)t=f(o,t,d(n.type,n.tag)),t=u(e[a],n.type,t,o,i);return t}function f(e,n,t){for(var o=0;o<t.length;o++,n++)e[n]=t[o];return n}function d(e,n){var t=i.TYPES[e]||2;return r.encodeUInt32(n<<3|t)}o.init=function(e){this.protos=e||{}},o.encode=function(e,n){var t=this.protos[e];if(!a(n,t))return null;var o=r.byteLength(JSON.stringify(n)),i=new ArrayBuffer(o),c=new Uint8Array(i),u=0;return t&&(u=s(c,u,t,n))>0?c.subarray(0,u):null}}("undefined"!=typeof protobuf?protobuf:module.exports),function(e,n){var t,o=e,r=e.decoder={},i=o.codec,c=o.util,a=0;function s(e,n,t){for(;a<t;){var o=u(),r=(o.type,o.tag),i=n.__tags[r];switch(n[i].option){case"optional":case"required":e[i]=l(n[i].type,n);break;case"repeated":e[i]||(e[i]=[]),f(e[i],n[i].type,n)}}return e}function u(){var e=i.decodeUInt32(d());return{type:7&e,tag:e>>3}}function l(e,n){switch(e){case"uInt32":return i.decodeUInt32(d());case"int32":case"sInt32":return i.decodeSInt32(d());case"float":var o=i.decodeFloat(t,a);return a+=4,o;case"double":var c=i.decodeDouble(t,a);return a+=8,c;case"string":var u=i.decodeUInt32(d()),l=i.decodeStr(t,a,u);return a+=u,l;default:var f=n&&(n.__messages[e]||r.protos["message "+e]);if(f){u=i.decodeUInt32(d());var p={};return s(p,f,a+u),p}}}function f(e,n,t){if(c.isSimpleType(n))for(var o=i.decodeUInt32(d()),r=0;r<o;r++)e.push(l(n));else e.push(l(n,t))}function d(e){var n,o=[],r=a;e=e||!1;do{n=t[r],o.push(n),r++}while(n>=128);return e||(a=r),o}r.init=function(e){this.protos=e||{}},r.setProtos=function(e){e&&(this.protos=e)},r.decode=function(e,n){var o=this.protos[e];return t=n,a=0,o?s({},o,t.length):null}}("undefined"!=typeof protobuf?protobuf:module.exports),cc.Pomelo=function(){var e=window.Protocol,n=window.protobuf,t=window.decodeIO_protobuf,o=null,r=null,i=e.Package,c=e.Message,a=window.EventEmitter,s=window.rsa,u=null;"undefined"!=typeof window&&"undefined"!=typeof sys&&sys.localStorage&&(window.localStorage=sys.localStorage);"function"!=typeof Object.create&&(Object.create=function(e){function n(){}return n.prototype=e,new n});window;var l=Object.create(a.prototype),f=null,d=0,p={},h={},y={},v={},g={},w={},b={},m=0,E=0,_=0,T=0,S=null,P=null,I=null,A=null,k=null;var Y,N=!1,U=!1,O=!1,D=null,H=null,J=0,R=0,C={sys:{type:"js-websocket",version:"0.0.1",rsa:{}},user:{}},x=null;l.init=function(e,n){x=n;var t=e.host,o=e.port,r=e.secret||!1;k=e.encode||j,A=e.decode||K;var i="";if(i=r?"wss://"+t:"ws://"+t,o&&(i+=":"+o),C.user=e.user,e.encrypt){Y=!0,s.generate(1024,"10001");var c={rsa_n:s.n.toString(16),rsa_e:s.e};C.sys.rsa=c}I=e.handshakeCallback,F(e,i,n)};var K=l.decode=function(e){var n=c.decode(e);if(!(n.id>0)||(n.route=y[n.id],delete y[n.id],n.route))return n.body=V(n),n},j=l.encode=function(t,r,i){var a=t?c.TYPE_REQUEST:c.TYPE_NOTIFY;if(n&&b[r])i=n.encode(r,i);else if(o&&o.lookup(r)){i=new(o.build(r))(i).encodeNB()}else i=e.strencode(JSON.stringify(i));var s=0;return v&&v[r]&&(r=v[r],s=1),c.encode(t,a,s,r,i)},F=function(c,a,s){console.log("connect to url=%s",a),N=!!(c=c||{}).reconnect&&c.reconnect;var d=c.maxReconnectAttempts||7;if(H=a,window.localStorage&&window.localStorage.getItem("protos")&&0===m){var p=JSON.parse(window.localStorage.getItem("protos"));m=p.version||0,w=p.server||{},b=p.client||{},n&&n.init({encoderProtos:b,decoderProtos:w}),t&&(o=t.loadJson(b),r=t.loadJson(w))}C.sys.protoVersion=m;(f=new WebSocket(a)).binaryType="arraybuffer",f.onopen=function(n){console.log("pomelo-client onopen"),l.emit("open"),L();var t=i.encode(i.TYPE_HANDSHAKE,e.strencode(JSON.stringify(C)));M(t)},f.onmessage=function(e){Q(i.decode(e.data),s),_&&(T=Date.now()+_)},f.onerror=function(e){console.log("pomelo-client onerror"),l.emit("io-error",e),f=null},f.onclose=function(e){console.log("pomelo-client onclose"),console.log(e),l.emit("close",e),!N||U||O||(J+1<=d?(D&&clearTimeout(D),D=setTimeout(function(){F(c,H,s),J++,l.emit("reconnecting",{reconnectAttempts:J,maxReconnectAttempts:d})},R),(R+=3e3)>5e3&&(R=5e3)):l.emit("reconnect_fail")),f=null,u&&u(),u=null}};l.disconnect=function(e){console.log("pomelo.disconnect"),u=e,L(),O=!0,f&&(f.disconnect&&f.disconnect(),f.close&&f.close(),f=null),S&&(clearTimeout(S),S=null),P&&(clearTimeout(P),P=null)};var L=function(){R=0,J=0,U=!1,O=!1,clearTimeout(D)};l.request=function(e,n,t){2===arguments.length&&"function"==typeof n?(t=n,n={}):n=n||{},(e=e||n.route)&&(B(++d,e,n),p[d]=t,y[d]=e)},l.notify=function(e,n){B(0,e,n=n||{})};var B=function(e,n,t){if(Y){t=JSON.stringify(t);var o=s.signString(t,"sha256");(t=JSON.parse(t)).__crypto__=o}k&&(t=k(e,n,t));var r=i.encode(i.TYPE_DATA,t);M(r)},M=function(e){if(f){if(f.readyState!=WebSocket.OPEN)return void l.emit("toobusy");f.send(e.buffer)}},q=function(){var e=T-Date.now();e>100?P=setTimeout(q,e):(console.error("server heartbeat timeout"),l.emit("heartbeat timeout"),l.disconnect())};h[i.TYPE_HANDSHAKE]=function(n){if(console.log("pomelo-client handshake"),501!==(n=JSON.parse(e.strdecode(n))).code)if(200===n.code){z(n);var t=i.encode(i.TYPE_HANDSHAKE_ACK);M(t),x&&x(f)}else l.emit("error","handshake fail");else l.emit("error","client version not fullfill")},h[i.TYPE_HEARTBEAT]=function(e){if(E){var n=i.encode(i.TYPE_HEARTBEAT);P&&(clearTimeout(P),P=null),S||(S=setTimeout(function(){S=null,M(n),T=Date.now()+_,P=setTimeout(q,_)},E))}},h[i.TYPE_DATA]=function(e){console.log("pomelo-client onData");var n=e;A&&(n=A(n)),W(l,n)},h[i.TYPE_KICK]=function(n){L(),U=!0,n=JSON.parse(e.strdecode(n)),l.emit("kick",n)};var Q=function(e){if(Array.isArray(e))for(var n=0;n<e.length;n++){var t=e[n];h[t.type](t.body)}else h[e.type](e.body)},W=function(e,n){if(n.id){var t=p[n.id];delete p[n.id],"function"==typeof t&&t(n.body)}else e.emit(n.route,n.body)},V=function(t){var o=t.route;if(t.compressRoute){if(!g[o])return{};o=t.route=g[o]}return n&&w[o]?n.decode(o,t.body):r&&r.lookup(o)?r.build(o).decode(t.body):JSON.parse(e.strdecode(t.body))},z=function(e){e.sys&&e.sys.heartbeat?(E=1e3*e.sys.heartbeat,_=4e4):(E=0,_=0),G(e),"function"==typeof I&&I(e.user)},G=function(e){if(e&&e.sys){v=e.sys.dict;var i=e.sys.protos;if(v)for(var c in g={},v=v)g[v[c]]=c;i&&(m=i.version||0,w=i.server||{},b=i.client||{},window.localStorage.setItem("protos",JSON.stringify(i)),n&&n.init({encoderProtos:i.client,decoderProtos:i.server}),t&&(o=t.loadJson(b),r=t.loadJson(w)))}};return l},"undefined"==typeof pomelo&&(window.pomelo=new cc.Pomelo);